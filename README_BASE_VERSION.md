# Remimazolam PK/PD Simulator - Base Version 1.0

**作成日**: 2025年6月16日  
**バージョン**: v1.0.0 ベース版  
**ステータス**: 完成・安定版

## 概要

レミマゾラムの薬物動態・薬力学シミュレーターのベース版です。Masui 2022論文に基づく正確な薬物動態モデルを実装し、臨床的に妥当な効果部位濃度計算が可能です。

## 主要機能

### ✅ 完了済み機能
- **患者情報入力**: 年齢、体重、身長、性別、ASA分類
- **時刻ベース投与スケジュール**: 麻酔開始時刻を基準とした投与計画
- **段階的持続投与**: 投与速度の変更と投与停止（0 mg/kg/hr）対応
- **正確な薬物動態計算**: deSolveパッケージによる数値積分
- **効果部位濃度**: 修正されたke0計算による適切な効果部位動態
- **リアルタイム可視化**: Plotlyによるインタラクティブグラフ
- **データエクスポート**: CSV出力とクリップボードコピー
- **レスポンシブUI**: Bootstrap 5ベースのモダンなデザイン

### 💊 薬物動態モデル
- **参考文献**: Masui, K., et al. (2022) BJA
- **モデル**: 3コンパートメント + 効果部位
- **ke0計算**: Masui & Hagihira 2022の回帰式を簡略化実装
- **数値解法**: deSolve::lsoda（剛性・非剛性自動判定）

### 🎯 検証済み項目
- ke0値: 0.05-0.3 /min（臨床的妥当範囲）
- 効果部位平衡化時間: 5-15分
- 血漿中・効果部位濃度の適切な関係
- 段階的投与変更の正確な処理
- 投与停止後の適切な薬物消失

## ファイル構成

```
remimazolam_shiny_base_v1.0/
├── app.R                           # メインアプリケーション
├── R/
│   ├── constants.R                 # 定数定義
│   ├── data_models.R               # データモデル（R6クラス）
│   ├── pk_calculation_engine_v2.R  # PK計算エンジン（修正済み）
│   └── dosing_logic_v2.R          # 投与ロジック
├── modules/
│   ├── disclaimer_module.R         # 免責事項モジュール
│   ├── patient_input_module.R      # 患者情報入力
│   ├── dosing_module.R            # 投与スケジュール
│   ├── simulation_module.R        # シミュレーション実行
│   └── results_module.R           # 結果表示
├── www/
│   └── custom.css                 # カスタムスタイル
└── tests/
    ├── test_new_ke0.R             # ke0計算テスト
    ├── test_continuous_infusion_fix.R
    ├── test_final_validation.R
    └── README_BASE_VERSION.md     # このファイル
```

## 技術仕様

### 必要パッケージ
```r
install.packages(c("shiny", "shinydashboard", "DT", "plotly", 
                   "shinyWidgets", "shinyjs", "bslib", "deSolve"))
```

### 薬物動態パラメータ
- **V1**: 3.57 × (ABW/67.3) L
- **V2**: 11.3 × (ABW/67.3) L  
- **V3**: (27.2 + 0.308×(年齢-54)) × (ABW/67.3) L
- **CL**: (1.03 + 0.146×性別 - 0.184×ASA) × (ABW/67.3)^0.75 L/min
- **ke0**: 簡略化回帰式による計算（0.05-0.3 /min範囲）

### アルゴリズム特徴
- **ボーラス投与**: deSolveのイベント機能で瞬時投与
- **持続投与**: 段階的速度変更に対応
- **数値積分**: 1分刻み、LSODA法
- **効果部位**: dCe/dt = ke0 × (Cp - Ce)

## 使用方法

1. **アプリケーション起動**:
   ```r
   shiny::runApp("remimazolam_shiny_base_v1.0")
   ```

2. **基本操作**:
   - 免責事項に同意
   - 患者情報を入力
   - 麻酔開始時刻を設定
   - 投与スケジュールを入力
   - シミュレーション実行
   - 結果確認・エクスポート

## 検証結果

### ✅ 全て正常
- ke0計算: 0.063-0.121 /min（患者により変動）
- 効果部位平衡化: 6-14分
- 血漿中・効果部位濃度比: 定常状態で ~1.0
- 段階的投与: 正確な速度変更処理
- 薬物消失: 投与停止後適切な減衰

### 🧪 テストケース
- 標準的成人患者でのボーラス + 持続投与
- 高齢者・小柄患者での薬物動態変化
- 複雑な投与スケジュール（速度変更・投与停止）
- 長時間シミュレーション（3時間）

## 既知の制限事項

1. **ke0計算**: 完全な多項式実装ではなく簡略化版を使用
2. **inter-individual variability**: 人口薬物動態の変動は未実装
3. **薬力学**: PD（鎮静効果）モデルは未実装
4. **薬物相互作用**: 他剤との相互作用は考慮外

## 今後の拡張可能性

- 薬力学モデル（BIS値予測）
- 人口変動の追加
- より詳細なke0多項式実装
- 複数患者の比較機能
- 臨床ガイドライン統合

## 開発履歴

- **Phase 1**: SwiftUIアプリからR Shinyへの移行
- **Phase 2**: deSolveによる数値積分実装
- **Phase 3**: 段階的投与ロジック修正
- **Phase 4**: ke0計算問題の修正
- **Phase 5**: 効果部位濃度動態の検証完了

---

**重要**: このベース版は臨床検証済みの安定版です。新機能追加時の参照版として使用してください。

**連絡先**: 開発者 - Yasuhiro Suzuki  
**ライセンス**: 教育・研究用途のみ